// UI Management and DOM Manipulation

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
});

function initializeApp() {
    // Set current date in date inputs
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('transactionDate').value = today;
    document.getElementById('futureTransactionStartDate').value = today;
    document.getElementById('loanDate').value = today;
    
    // Set current month in month filter
    const currentMonth = new Date().toISOString().slice(0, 7);
    document.getElementById('monthFilter').value = currentMonth;
    
    // Set current year and month in summary filters
    const currentYear = new Date().getFullYear();
    const currentMonthNum = new Date().getMonth() + 1;
    document.getElementById('summaryMonth').value = String(currentMonthNum).padStart(2, '0');
    document.getElementById('summaryYear').value = currentYear;
    
    // Initialize categories in dropdowns
    updateCategoryDropdowns();
    
    // Load initial data
    updateUI();
    
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    console.log('Wealth Command initialized successfully');
}

// Update all UI components
function updateUI() {
    updateTransactionsList();
    updateSummaryCards();
    updateCharts();
    updateCategoryDropdowns();
    updateRolloverDisplay();
    updateAnalytics();
    updatePlanner();
    updateDebtManagement();
    updateSettings();
}

// Update transactions list
function updateTransactionsList() {
    const tableBody = document.getElementById('transactionsTable');
    const typeFilter = document.getElementById('transactionTypeFilter').value;
    const categoryFilter = document.getElementById('categoryFilter').value;
    const monthFilter = document.getElementById('monthFilter').value;
    const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
    
    let filteredTransactions = transactions;
    
    // Apply filters
    if (typeFilter !== 'all') {
        filteredTransactions = filteredTransactions.filter(tx => tx.type === typeFilter);
    }
    
    if (categoryFilter !== 'all') {
        filteredTransactions = filteredTransactions.filter(tx => tx.category === categoryFilter);
    }
    
    if (monthFilter) {
        filteredTransactions = filteredTransactions.filter(tx => {
            const txMonth = tx.date.substring(0, 7);
            return txMonth === monthFilter;
        });
    }
    
    if (searchFilter) {
        filteredTransactions = filteredTransactions.filter(tx => 
            tx.description.toLowerCase().includes(searchFilter)
        );
    }
    
    // Sort by date (newest first)
    filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    // Update table
    tableBody.innerHTML = '';
    
    if (filteredTransactions.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted py-4">
                    <i class="bi bi-receipt fs-1 d-block mb-2"></i>
                    No transactions found
                </td>
            </tr>
        `;
        return;
    }
    
    filteredTransactions.forEach(transaction => {
        const category = categories.find(cat => cat.id === transaction.category);
        const row = document.createElement('tr');
        
        row.innerHTML = `
            <td>${format(parseISO(transaction.date), 'MMM dd, yyyy')}</td>
            <td>${transaction.description}</td>
            <td>
                <span class="category-badge" style="background-color: ${category?.color || '#6c757d'}; color: white;">
                    ${category?.name || 'Uncategorized'}
                </span>
            </td>
            <td>
                <span class="badge ${transaction.type === 'income' ? 'bg-success' : 'bg-danger'}">
                    ${transaction.type === 'income' ? 'Income' : 'Expense'}
                </span>
            </td>
            <td class="${transaction.type === 'income' ? 'text-success' : 'text-danger'}">
                ${transaction.type === 'income' ? '+' : '-'}${transaction.amount.toLocaleString()} ${currency}
            </td>
            <td>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteTransaction('${transaction.id}')">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        
        tableBody.appendChild(row);
    });
    
    // Update recent transactions
    updateRecentTransactions();
}

// Update recent transactions in dashboard
function updateRecentTransactions() {
    const container = document.getElementById('recentTransactions');
    const recent = transactions
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 10);
    
    container.innerHTML = '';
    
    if (recent.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="bi bi-receipt fs-1 d-block mb-2"></i>
                No transactions yet
            </div>
        `;
        return;
    }
    
    recent.forEach(transaction => {
        const category = categories.find(cat => cat.id === transaction.category);
        const item = document.createElement('div');
        item.className = `transaction-item ${transaction.type === 'income' ? 'transaction-income' : 'transaction-expense'}`;
        
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <div class="fw-bold">${transaction.description}</div>
                    <div class="small text-muted">
                        <span class="category-badge" style="background-color: ${category?.color || '#6c757d'}; color: white;">
                            ${category?.name || 'Uncategorized'}
                        </span>
                        • ${format(parseISO(transaction.date), 'MMM dd')}
                    </div>
                </div>
                <div class="text-end">
                    <div class="fw-bold ${transaction.type === 'income' ? 'text-success' : 'text-danger'}">
                        ${transaction.type === 'income' ? '+' : '-'}${transaction.amount.toLocaleString()} ${currency}
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(item);
    });
}

// Update summary cards
function updateSummaryCards() {
    const monthSel = document.getElementById('summaryMonth');
    const yearSel = document.getElementById('summaryYear');
    
    let filteredTransactions = transactions;
    
    if (monthSel.value !== 'all' && yearSel.value !== 'all') {
        const monthKey = `${yearSel.value}-${String(monthSel.value).padStart(2, '0')}`;
        filteredTransactions = transactions.filter(tx => getMonthKeyFromDate(tx.date) === monthKey);
    } else if (yearSel.value !== 'all') {
        filteredTransactions = transactions.filter(tx => tx.date.startsWith(yearSel.value));
    }
    
    const totalIncome = filteredTransactions
        .filter(tx => tx.type === 'income')
        .reduce((sum, tx) => sum + tx.amount, 0);
    
    const totalExpenses = filteredTransactions
        .filter(tx => tx.type === 'expense')
        .reduce((sum, tx) => sum + tx.amount, 0);
    
    const netBalance = totalIncome - totalExpenses;
    
    document.getElementById('totalIncome').textContent = totalIncome.toLocaleString();
    document.getElementById('totalExpenses').textContent = totalExpenses.toLocaleString();
    document.getElementById('netBalance').textContent = netBalance.toLocaleString();
}

// Update charts
function updateCharts() {
    updateMainChart();
    updatePieCharts();
}

// Update main chart
function updateMainChart() {
    const ctx = document.getElementById('mainChart').getContext('2d');
    const monthSel = document.getElementById('summaryMonth');
    const yearSel = document.getElementById('summaryYear');
    
    let labels = [];
    let incomeData = [];
    let expenseData = [];
    
    if (monthSel.value !== 'all' && yearSel.value !== 'all') {
        // Daily data for selected month
        const monthKey = `${yearSel.value}-${String(monthSel.value).padStart(2, '0')}`;
        const daysInMonth = new Date(parseInt(yearSel.value), parseInt(monthSel.value), 0).getDate();
        
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${monthKey}-${String(day).padStart(2, '0')}`;
            const dayTransactions = transactions.filter(tx => tx.date === dateStr);
            
            const dayIncome = dayTransactions.filter(tx => tx.type === 'income')
                .reduce((sum, tx) => sum + tx.amount, 0);
            const dayExpense = dayTransactions.filter(tx => tx.type === 'expense')
                .reduce((sum, tx) => sum + tx.amount, 0);
            
            labels.push(`${day}`);
            incomeData.push(dayIncome);
            expenseData.push(dayExpense);
        }
    } else {
        // Monthly data
        const months = {};
        transactions.forEach(tx => {
            const month = getMonthKeyFromDate(tx.date);
            if (!months[month]) {
                months[month] = { income: 0, expenses: 0 };
            }
            
            if (tx.type === 'income') {
                months[month].income += tx.amount;
            } else {
                months[month].expenses += tx.amount;
            }
        });
        
        const sortedMonths = Object.keys(months).sort();
        labels = sortedMonths.map(month => format(parseISO(month + '-01'), 'MMM yyyy'));
        incomeData = sortedMonths.map(month => months[month].income);
        expenseData = sortedMonths.map(month => months[month].expenses);
    }
    
    if (mainChart) {
        mainChart.destroy();
    }
    
    mainChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Income',
                    data: incomeData,
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Expenses',
                    data: expenseData,
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.4,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Income vs Expenses Over Time'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString() + ' ' + currency;
                        }
                    }
                }
            }
        }
    });
}

// Update pie charts
function updatePieCharts() {
    updateIncomePieChart();
    updateExpensePieChart();
}

function updateIncomePieChart() {
    const ctx = document.getElementById('incomePieChart').getContext('2d');
    const monthSel = document.getElementById('summaryMonth');
    const yearSel = document.getElementById('summaryYear');
    
    let filteredTransactions = transactions.filter(tx => tx.type === 'income');
    
    if (monthSel.value !== 'all' && yearSel.value !== 'all') {
        const monthKey = `${yearSel.value}-${String(monthSel.value).padStart(2, '0')}`;
        filteredTransactions = filteredTransactions.filter(tx => getMonthKeyFromDate(tx.date) === monthKey);
    }
    
    const categoryData = {};
    filteredTransactions.forEach(tx => {
        categoryData[tx.category] = (categoryData[tx.category] || 0) + tx.amount;
    });
    
    const categoryLabels = [];
    const categoryAmounts = [];
    const categoryColors = [];
    
    Object.keys(categoryData).forEach(categoryId => {
        const category = categories.find(cat => cat.id === categoryId);
        if (category) {
            categoryLabels.push(category.name);
            categoryAmounts.push(categoryData[categoryId]);
            categoryColors.push(category.color);
        }
    });
    
    if (incomePieChart) {
        incomePieChart.destroy();
    }
    
    if (categoryAmounts.length === 0) {
        incomePieChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['No Data'],
                datasets: [{
                    data: [1],
                    backgroundColor: ['#6c757d']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: {
                        display: true,
                        text: 'No Income Data'
                    }
                }
            }
        });
        return;
    }
    
    incomePieChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: categoryLabels,
            datasets: [{
                data: categoryAmounts,
                backgroundColor: categoryColors
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Income Distribution'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${context.label}: ${value.toLocaleString()} ${currency} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function updateExpensePieChart() {
    const ctx = document.getElementById('expensePieChart').getContext('2d');
    const monthSel = document.getElementById('summaryMonth');
    const yearSel = document.getElementById('summaryYear');
    
    let filteredTransactions = transactions.filter(tx => tx.type === 'expense');
    
    if (monthSel.value !== 'all' && yearSel.value !== 'all') {
        const monthKey = `${yearSel.value}-${String(monthSel.value).padStart(2, '0')}`;
        filteredTransactions = filteredTransactions.filter(tx => getMonthKeyFromDate(tx.date) === monthKey);
    }
    
    const categoryData = {};
    filteredTransactions.forEach(tx => {
        categoryData[tx.category] = (categoryData[tx.category] || 0) + tx.amount;
    });
    
    const categoryLabels = [];
    const categoryAmounts = [];
    const categoryColors = [];
    
    Object.keys(categoryData).forEach(categoryId => {
        const category = categories.find(cat => cat.id === categoryId);
        if (category) {
            categoryLabels.push(category.name);
            categoryAmounts.push(categoryData[categoryId]);
            categoryColors.push(category.color);
        }
    });
    
    if (expensePieChart) {
        expensePieChart.destroy();
    }
    
    if (categoryAmounts.length === 0) {
        expensePieChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['No Data'],
                datasets: [{
                    data: [1],
                    backgroundColor: ['#6c757d']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: {
                        display: true,
                        text: 'No Expense Data'
                    }
                }
            }
        });
        return;
    }
    
    expensePieChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: categoryLabels,
            datasets: [{
                data: categoryAmounts,
                backgroundColor: categoryColors
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Expense Distribution'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${context.label}: ${value.toLocaleString()} ${currency} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// Update category dropdowns
function updateCategoryDropdowns() {
    const dropdowns = [
        'transactionCategory',
        'futureTransactionCategory',
        'categoryFilter'
    ];
    
    dropdowns.forEach(dropdownId => {
        const dropdown = document.getElementById(dropdownId);
        if (!dropdown) return;
        
        const currentValue = dropdown.value;
        dropdown.innerHTML = '<option value="all">All Categories</option>';
        
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            dropdown.appendChild(option);
        });
        
        // Restore previous value if it still exists
        if (categories.some(cat => cat.id === currentValue)) {
            dropdown.value = currentValue;
        }
    });
    
    // Update transaction category dropdown (no "all" option)
    const transactionCategory = document.getElementById('transactionCategory');
    if (transactionCategory) {
        const currentValue = transactionCategory.value;
        transactionCategory.innerHTML = '';
        
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            transactionCategory.appendChild(option);
        });
        
        if (categories.some(cat => cat.id === currentValue)) {
            transactionCategory.value = currentValue;
        }
    }
    
    // Update future transaction category dropdown
    const futureTransactionCategory = document.getElementById('futureTransactionCategory');
    if (futureTransactionCategory) {
        const currentValue = futureTransactionCategory.value;
        futureTransactionCategory.innerHTML = '';
        
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            futureTransactionCategory.appendChild(option);
        });
        
        if (categories.some(cat => cat.id === currentValue)) {
            futureTransactionCategory.value = currentValue;
        }
    }
}

// Add transaction
function addTransaction() {
    const type = document.getElementById('transactionType').value;
    const amount = parseFloat(document.getElementById('transactionAmount').value);
    const description = document.getElementById('transactionDescription').value;
    const category = document.getElementById('transactionCategory').value;
    const date = document.getElementById('transactionDate').value;
    
    if (!amount || !description || !category || !date) {
        showToast('Please fill in all fields', 'warning');
        return;
    }
    
    const transaction = {
        id: generateId(),
        type: type,
        amount: amount,
        description: description,
        category: category,
        date: date
    };
    
    transactions.push(transaction);
    saveTransactions();
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('addTransactionModal'));
    modal.hide();
    
    // Reset form
    document.getElementById('transactionForm').reset();
    
    // Update UI
    updateUI();
    calculateMonthlyRollover();
    
    showToast('Transaction added successfully', 'success');
}

// Add category
function addCategory() {
    const name = document.getElementById('categoryName').value;
    const type = document.getElementById('categoryType').value;
    const color = document.getElementById('categoryColor').value;
    
    if (!name) {
        showToast('Please enter a category name', 'warning');
        return;
    }
    
    const category = {
        id: generateId(),
        name: name,
        type: type,
        color: color
    };
    
    categories.push(category);
    saveCategories();
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('addCategoryModal'));
    modal.hide();
    
    // Reset form
    document.getElementById('categoryForm').reset();
    
    // Update UI
    updateCategoryDropdowns();
    updateUI();
    
    showToast('Category added successfully', 'success');
}

// Add future transaction
function addFutureTransaction() {
    const type = document.getElementById('futureTransactionType').value;
    const amount = parseFloat(document.getElementById('futureTransactionAmount').value);
    const description = document.getElementById('futureTransactionDescription').value;
    const category = document.getElementById('futureTransactionCategory').value;
    const startDate = document.getElementById('futureTransactionStartDate').value;
    const frequency = document.getElementById('futureTransactionFrequency').value;
    const endDate = document.getElementById('futureTransactionEndDate').value || null;
    
    if (!amount || !description || !category || !startDate) {
        showToast('Please fill in all required fields', 'warning');
        return;
    }
    
    const futureTransaction = {
        id: generateId(),
        type: type,
        amount: amount,
        description: description,
        category: category,
        startDate: startDate,
        frequency: frequency,
        endDate: endDate
    };
    
    if (type === 'income') {
        futureTransactions.income.push(futureTransaction);
    } else {
        futureTransactions.expenses.push(futureTransaction);
    }
    
    saveFutureTransactions();
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('addFutureTransactionModal'));
    modal.hide();
    
    // Reset form
    document.getElementById('futureTransactionForm').reset();
    
    // Update UI
    updatePlanner();
    
    showToast('Future transaction added successfully', 'success');
}

// Add loan
function addLoan() {
    const loanType = document.getElementById('loanType').value;
    const amount = parseFloat(document.getElementById('loanAmount').value);
    const person = document.getElementById('loanPerson').value;
    const description = document.getElementById('loanDescription').value;
    const date = document.getElementById('loanDate').value;
    const dueDate = document.getElementById('loanDueDate').value;
    const interest = parseFloat(document.getElementById('loanInterest').value) || 0;
    
    if (!amount || !person || !date || !dueDate) {
        showToast('Please fill in all required fields', 'warning');
        return;
    }
    
    const loan = {
        id: generateId(),
        amount: amount,
        person: person,
        description: description,
        date: date,
        dueDate: dueDate,
        interest: interest,
        status: 'pending',
        payments: []
    };
    
    if (loanType === 'given') {
        loans.given.push(loan);
    } else {
        loans.taken.push(loan);
    }
    
    saveLoans();
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('addLoanModal'));
    modal.hide();
    
    // Reset form
    document.getElementById('loanForm').reset();
    
    // Update UI
    updateDebtManagement();
    
    showToast('Loan added successfully', 'success');
}

// Delete transaction
function deleteTransaction(id) {
    if (!confirm('Are you sure you want to delete this transaction?')) {
        return;
    }
    
    transactions = transactions.filter(tx => tx.id !== id);
    saveTransactions();
    updateUI();
    calculateMonthlyRollover();
    
    showToast('Transaction deleted successfully', 'success');
}

// Save functions
function saveTransactions() {
    localStorage.setItem('transactions', JSON.stringify(transactions));
    autoSyncToDrive();
}

function saveCategories() {
    localStorage.setItem('categories', JSON.stringify(categories));
    autoSyncToDrive();
}

function saveFutureTransactions() {
    localStorage.setItem('futureTransactions', JSON.stringify(futureTransactions));
    autoSyncToDrive();
}

function saveLoans() {
    localStorage.setItem('loans', JSON.stringify(loans));
    autoSyncToDrive();
}

// Utility functions
function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

// Analytics functions
function updateAnalytics() {
    updateHealthScore();
    updateAIInsights();
    updateCategoryTrendChart();
    updateHeatMap();
    updateComparisonChart();
}

function updateHealthScore() {
    const healthScore = AnalyticsEngine.calculateHealthScore(transactions, monthlyBudgets);
    const healthScoreElement = document.getElementById('healthScore');
    const healthScoreBar = document.getElementById('healthScoreBar');
    const healthScoreText = document.getElementById('healthScoreText');
    
    healthScoreElement.textContent = healthScore;
    healthScoreBar.style.width = `${healthScore}%`;
    
    // Update bar color based on score
    if (healthScore >= 80) {
        healthScoreBar.className = 'progress-bar bg-success';
        healthScoreText.textContent = 'Excellent financial health! Keep up the good work.';
    } else if (healthScore >= 60) {
        healthScoreBar.className = 'progress-bar bg-info';
        healthScoreText.textContent = 'Good financial health. There\'s room for improvement.';
    } else if (healthScore >= 40) {
        healthScoreBar.className = 'progress-bar bg-warning';
        healthScoreText.textContent = 'Fair financial health. Consider reviewing your spending habits.';
    } else {
        healthScoreBar.className = 'progress-bar bg-danger';
        healthScoreText.textContent = 'Poor financial health. Immediate attention recommended.';
    }
    
    // Update health trend chart
    updateHealthTrendChart();
}

function updateHealthTrendChart() {
    const ctx = document.getElementById('healthTrendChart').getContext('2d');
    
    // Calculate health scores for last 6 months
    const now = new Date();
    const months = [];
    const scores = [];
    
    for (let i = 5; i >= 0; i--) {
        const date = subMonths(now, i);
        const monthKey = format(date, 'yyyy-MM');
        const monthName = format(date, 'MMM yyyy');
        
        // Filter transactions for this month
        const monthTransactions = transactions.filter(tx => 
            getMonthKeyFromDate(tx.date) === monthKey
        );
        
        const score = AnalyticsEngine.calculateHealthScore(monthTransactions, monthlyBudgets);
        months.push(monthName);
        scores.push(score);
    }
    
    if (healthTrendChart) {
        healthTrendChart.destroy();
    }
    
    healthTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: months,
            datasets: [{
                label: 'Financial Health Score',
                data: scores,
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    min: 0,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + ' pts';
                        }
                    }
                }
            }
        }
    });
}

function updateAIInsights() {
    const insightsContainer = document.getElementById('aiInsights');
    const insights = AnalyticsEngine.generateInsights(transactions, monthlyBudgets);
    
    insightsContainer.innerHTML = '';
    
    if (insights.length === 0) {
        insightsContainer.innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="bi bi-info-circle fs-1 d-block mb-2"></i>
                Add more transactions to get insights
            </div>
        `;
        return;
    }
    
    insights.forEach(insight => {
        const insightElement = document.createElement('div');
        insightElement.className = `insight-card insight-${insight.type} mb-3`;
        
        insightElement.innerHTML = `
            <div class="d-flex align-items-start">
                <i class="bi ${insight.icon} me-2"></i>
                <div class="flex-grow-1">
                    ${insight.message}
                </div>
            </div>
        `;
        
        insightsContainer.appendChild(insightElement);
    });
}

function updateCategoryTrendChart() {
    const ctx = document.getElementById('categoryTrendChart').getContext('2d');
    const trends = AnalyticsEngine.analyzeCategoryTrends(transactions);
    
    const labels = trends.map(trend => trend.category);
    const data = trends.map(trend => trend.trend * 100); // Convert to percentage
    
    if (categoryTrendChart) {
        categoryTrendChart.destroy();
    }
    
    categoryTrendChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Monthly Change (%)',
                data: data,
                backgroundColor: data.map(value => 
                    value > 0 ? 'rgba(220, 53, 69, 0.8)' : 'rgba(40, 167, 69, 0.8)'
                )
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Category Spending Trends (vs Last Month)'
                }
            },
            scales: {
                y: {
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });
}

function updateHeatMap() {
    const heatMapContainer = document.getElementById('heatMap');
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth() + 1;
    
    const heatMap = AnalyticsEngine.generateHeatMap(transactions, year, month);
    
    heatMapContainer.innerHTML = '';
    
    heatMap.forEach(day => {
        const dayElement = document.createElement('div');
        dayElement.className = 'heatmap-day';
        
        let intensityClass = 'heatmap-empty';
        if (day.amount > 0) {
            if (day.amount < 100) intensityClass = 'heatmap-low';
            else if (day.amount < 500) intensityClass = 'heatmap-medium';
            else if (day.amount < 1000) intensityClass = 'heatmap-high';
            else intensityClass = 'heatmap-very-high';
        }
        
        dayElement.className += ' ' + intensityClass;
        dayElement.title = `${format(parseISO(day.date), 'MMM dd')}: ${day.amount.toLocaleString()} ${currency}`;
        dayElement.textContent = day.day;
        
        dayElement.addEventListener('click', () => {
            showDayTransactions(day.date);
        });
        
        heatMapContainer.appendChild(dayElement);
    });
}

function showDayTransactions(date) {
    const dayTransactions = transactions.filter(tx => tx.date === date && tx.type === 'expense');
    
    if (dayTransactions.length === 0) {
        showToast('No transactions found for this day', 'info');
        return;
    }
    
    let message = `Transactions for ${format(parseISO(date), 'MMM dd, yyyy')}:\n\n`;
    dayTransactions.forEach(tx => {
        const category = categories.find(cat => cat.id === tx.category);
        message += `• ${tx.description}: ${tx.amount.toLocaleString()} ${currency} (${category?.name || 'Uncategorized'})\n`;
    });
    
    alert(message);
}

function updateComparisonChart() {
    // This would be implemented to compare two periods
    // For now, we'll just initialize an empty chart
    const ctx = document.getElementById('comparisonChart').getContext('2d');
    
    if (comparisonChart) {
        comparisonChart.destroy();
    }
    
    comparisonChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Select periods to compare'],
            datasets: []
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

// Planner functions
function updatePlanner() {
    const timeframe = document.getElementById('plannerTimeframe').value;
    const currentBalance = getCurrentBalance();
    
    const projections = PlannerEngine.calculateProjections(futureTransactions, timeframe, currentBalance);
    
    updateProjectionSummary(projections.summary);
    updateProjectionChart(projections);
    updatePlannedTransactions();
}

function getCurrentBalance() {
    const totalIncome = transactions.filter(tx => tx.type === 'income')
        .reduce((sum, tx) => sum + tx.amount, 0);
    const totalExpenses = transactions.filter(tx => tx.type === 'expense')
        .reduce((sum, tx) => sum + tx.amount, 0);
    
    return totalIncome - totalExpenses;
}

function updateProjectionSummary(summary) {
    document.getElementById('projectedIncome').textContent = summary.totalIncome.toLocaleString();
    document.getElementById('projectedExpenses').textContent = summary.totalExpenses.toLocaleString();
    document.getElementById('netWealthChange').textContent = summary.netWealth.toLocaleString();
    document.getElementById('endingBalance').textContent = summary.endingBalance.toLocaleString();
    
    // Color code net wealth change
    const netWealthElement = document.getElementById('netWealthChange');
    if (summary.netWealth > 0) {
        netWealthElement.className = 'text-success';
    } else if (summary.netWealth < 0) {
        netWealthElement.className = 'text-danger';
    } else {
        netWealthElement.className = 'text-muted';
    }
}

function updateProjectionChart(projections) {
    const ctx = document.getElementById('projectionChart').getContext('2d');
    
    const labels = projections.months.map(month => month.name);
    const balanceData = projections.months.map(month => month.balance);
    const incomeData = projections.months.map(month => month.income);
    const expenseData = projections.months.map(month => month.expenses);
    
    if (window.projectionChart) {
        window.projectionChart.destroy();
    }
    
    window.projectionChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Projected Balance',
                    data: balanceData,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.4,
                    fill: true,
                    yAxisID: 'y'
                },
                {
                    label: 'Monthly Income',
                    data: incomeData,
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4,
                    fill: false,
                    yAxisID: 'y1'
                },
                {
                    label: 'Monthly Expenses',
                    data: expenseData,
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.4,
                    fill: false,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Balance'
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString() + ' ' + currency;
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Income/Expenses'
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString() + ' ' + currency;
                        }
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });
}

function updatePlannedTransactions() {
    updatePlannedIncome();
    updatePlannedExpenses();
}

function updatePlannedIncome() {
    const container = document.getElementById('plannedIncomeList');
    container.innerHTML = '';
    
    if (futureTransactions.income.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="bi bi-arrow-down-circle fs-1 d-block mb-2"></i>
                No planned income
            </div>
        `;
        return;
    }
    
    futureTransactions.income.forEach(income => {
        const category = categories.find(cat => cat.id === income.category);
        const item = document.createElement('div');
        item.className = 'transaction-item transaction-income mb-2';
        
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <div class="fw-bold">${income.description}</div>
                    <div class="small text-muted">
                        ${category?.name || 'Uncategorized'} • 
                        ${format(parseISO(income.startDate), 'MMM dd, yyyy')} • 
                        ${income.frequency}
                    </div>
                </div>
                <div class="text-end">
                    <div class="fw-bold text-success">+${income.amount.toLocaleString()} ${currency}</div>
                    <button class="btn btn-sm btn-outline-danger mt-1" onclick="deleteFutureTransaction('income', '${income.id}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `;
        
        container.appendChild(item);
    });
}

function updatePlannedExpenses() {
    const container = document.getElementById('plannedExpensesList');
    container.innerHTML = '';
    
    if (futureTransactions.expenses.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="bi bi-arrow-up-circle fs-1 d-block mb-2"></i>
                No planned expenses
            </div>
        `;
        return;
    }
    
    futureTransactions.expenses.forEach(expense => {
        const category = categories.find(cat => cat.id === expense.category);
        const item = document.createElement('div');
        item.className = 'transaction-item transaction-expense mb-2';
        
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <div class="fw-bold">${expense.description}</div>
                    <div class="small text-muted">
                        ${category?.name || 'Uncategorized'} • 
                        ${format(parseISO(expense.startDate), 'MMM dd, yyyy')} • 
                        ${expense.frequency}
                    </div>
                </div>
                <div class="text-end">
                    <div class="fw-bold text-danger">-${expense.amount.toLocaleString()} ${currency}</div>
                    <button class="btn btn-sm btn-outline-danger mt-1" onclick="deleteFutureTransaction('expenses', '${expense.id}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `;
        
        container.appendChild(item);
    });
}

function deleteFutureTransaction(type, id) {
    if (!confirm('Are you sure you want to delete this planned transaction?')) {
        return;
    }
    
    futureTransactions[type] = futureTransactions[type].filter(tx => tx.id !== id);
    saveFutureTransactions();
    updatePlanner();
    
    showToast('Planned transaction deleted successfully', 'success');
}

// Debt Management functions
function updateDebtManagement() {
    const summary = DebtEngine.calculateDebtSummary(loans);
    
    document.getElementById('totalGiven').textContent = summary.totalGiven.toLocaleString();
    document.getElementById('totalTaken').textContent = summary.totalTaken.toLocaleString();
    document.getElementById('netPosition').textContent = summary.netPosition.toLocaleString();
    
    // Color code net position
    const netPositionElement = document.getElementById('netPosition');
    if (summary.netPosition > 0) {
        netPositionElement.className = 'text-success';
    } else if (summary.netPosition < 0) {
        netPositionElement.className = 'text-danger';
    } else {
        netPositionElement.className = 'text-muted';
    }
    
    updateLoansGiven();
    updateLoansTaken();
    updateUpcomingRepayments(summary.upcomingRepayments);
}

function updateLoansGiven() {
    const container = document.getElementById('loansGivenList');
    container.innerHTML = '';
    
    if (loans.given.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="bi bi-arrow-up-right fs-1 d-block mb-2"></i>
                No loans given
            </div>
        `;
        return;
    }
    
    loans.given.forEach(loan => {
        const status = DebtEngine.getLoanStatus(loan);
        const paidAmount = DebtEngine.getPaidAmount(loan);
        const remainingAmount = loan.amount - paidAmount;
        
        const item = document.createElement('div');
        item.className = 'transaction-item mb-3';
        
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <div class="fw-bold">${loan.person}</div>
                    <div class="small text-muted">
                        ${loan.description || 'No description'} • 
                        Due: ${format(parseISO(loan.dueDate), 'MMM dd, yyyy')}
                    </div>
                    <div class="progress mt-2" style="height: 5px;">
                        <div class="progress-bar" style="width: ${(paidAmount / loan.amount) * 100}%"></div>
                    </div>
                    <div class="small">
                        ${paidAmount.toLocaleString()} ${currency} of ${loan.amount.toLocaleString()} ${currency} paid
                        <span class="loan-status-${status} float-end">
                            ${status.replace('_', ' ').toUpperCase()}
                        </span>
                    </div>
                </div>
                <div class="text-end ms-3">
                    <button class="btn btn-sm btn-outline-success" onclick="addLoanPayment('given', '${loan.id}')">
                        <i class="bi bi-plus-circle"></i> Payment
                    </button>
                </div>
            </div>
        `;
        
        container.appendChild(item);
    });
}

function updateLoansTaken() {
    const container = document.getElementById('loansTakenList');
    container.innerHTML = '';
    
    if (loans.taken.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="bi bi-arrow-down-left fs-1 d-block mb-2"></i>
                No loans taken
            </div>
        `;
        return;
    }
    
    loans.taken.forEach(loan => {
        const status = DebtEngine.getLoanStatus(loan);
        const paidAmount = DebtEngine.getPaidAmount(loan);
        const remainingAmount = loan.amount - paidAmount;
        
        const item = document.createElement('div');
        item.className = 'transaction-item mb-3';
        
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <div class="fw-bold">${loan.person}</div>
                    <div class="small text-muted">
                        ${loan.description || 'No description'} • 
                        Due: ${format(parseISO(loan.dueDate), 'MMM dd, yyyy')}
                    </div>
                    <div class="progress mt-2" style="height: 5px;">
                        <div class="progress-bar" style="width: ${(paidAmount / loan.amount) * 100}%"></div>
                    </div>
                    <div class="small">
                        ${paidAmount.toLocaleString()} ${currency} of ${loan.amount.toLocaleString()} ${currency} paid
                        <span class="loan-status-${status} float-end">
                            ${status.replace('_', ' ').toUpperCase()}
                        </span>
                    </div>
                </div>
                <div class="text-end ms-3">
                    <button class="btn btn-sm btn-outline-success" onclick="addLoanPayment('taken', '${loan.id}')">
                        <i class="bi bi-plus-circle"></i> Payment
                    </button>
                </div>
            </div>
        `;
        
        container.appendChild(item);
    });
}

function updateUpcomingRepayments(upcomingRepayments) {
    const container = document.getElementById('upcomingRepayments');
    container.innerHTML = '';
    
    if (upcomingRepayments.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="bi bi-calendar-check fs-1 d-block mb-2"></i>
                No upcoming repayments
            </div>
        `;
        return;
    }
    
    upcomingRepayments.forEach(loan => {
        const status = DebtEngine.getLoanStatus(loan);
        const paidAmount = DebtEngine.getPaidAmount(loan);
        const remainingAmount = loan.amount - paidAmount;
        const isGiven = loans.given.some(l => l.id === loan.id);
        
        const item = document.createElement('div');
        item.className = 'transaction-item mb-2';
        
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <div class="fw-bold">${loan.person}</div>
                    <div class="small text-muted">
                        ${isGiven ? 'You lent' : 'You borrowed'} • 
                        Due: ${format(parseISO(loan.expectedReturn || loan.dueDate), 'MMM dd, yyyy')}
                    </div>
                </div>
                <div class="text-end">
                    <div class="fw-bold ${isGiven ? 'text-info' : 'text-warning'}">
                        ${remainingAmount.toLocaleString()} ${currency}
                    </div>
                    <span class="loan-status-${status} small">
                        ${status.replace('_', ' ').toUpperCase()}
                    </span>
                </div>
            </div>
        `;
        
        container.appendChild(item);
    });
}

function addLoanPayment(loanType, loanId) {
    const loanArray = loanType === 'given' ? loans.given : loans.taken;
    const loan = loanArray.find(l => l.id === loanId);
    
    if (!loan) return;
    
    const remainingAmount = loan.amount - DebtEngine.getPaidAmount(loan);
    const amount = prompt(`Enter payment amount (remaining: ${remainingAmount.toLocaleString()} ${currency}):`, remainingAmount);
    
    if (!amount || isNaN(parseFloat(amount)) || parseFloat(amount) <= 0) {
        return;
    }
    
    const paymentAmount = parseFloat(amount);
    
    if (paymentAmount > remainingAmount) {
        showToast('Payment amount cannot exceed remaining amount', 'warning');
        return;
    }
    
    DebtEngine.addPayment(loan, paymentAmount);
    saveLoans();
    updateDebtManagement();
    
    showToast('Payment recorded successfully', 'success');
}

// Settings functions
function updateSettings() {
    updateCurrencySettings();
    updateCategoriesList();
}

function updateCurrencySettings() {
    const currencySelect = document.getElementById('currencySelect');
    if (currencySelect) {
        currencySelect.value = currency;
    }
}

function updateCategoriesList() {
    const container = document.getElementById('categoriesList');
    container.innerHTML = '';
    
    categories.forEach(category => {
        const item = document.createElement('div');
        item.className = 'd-flex justify-content-between align-items-center mb-2 p-2 border rounded';
        
        item.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="color-indicator me-2" style="width: 16px; height: 16px; background-color: ${category.color}; border-radius: 3px;"></div>
                <div>
                    <div class="fw-bold">${category.name}</div>
                    <div class="small text-muted">
                        <span class="badge ${category.type === 'income' ? 'bg-success' : 'bg-danger'}">
                            ${category.type}
                        </span>
                    </div>
                </div>
            </div>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory('${category.id}')">
                <i class="bi bi-trash"></i>
            </button>
        `;
        
        container.appendChild(item);
    });
}

function updateCurrency() {
    const newCurrency = document.getElementById('currencySelect').value;
    currency = newCurrency;
    localStorage.setItem('currency', currency);
    updateUI();
    showToast(`Currency updated to ${currency}`, 'success');
}

function deleteCategory(id) {
    if (!confirm('Are you sure you want to delete this category? Transactions using this category will become uncategorized.')) {
        return;
    }
    
    categories = categories.filter(cat => cat.id !== id);
    saveCategories();
    updateCategoryDropdowns();
    updateSettings();
    updateUI();
    
    showToast('Category deleted successfully', 'success');
}

// Data management functions
function exportData() {
    const data = {
        transactions: transactions,
        categories: categories,
        monthlyBudgets: monthlyBudgets,
        futureTransactions: futureTransactions,
        loans: loans,
        currency: currency,
        exportDate: new Date().toISOString()
    };
    
    const dataStr = JSON.stringify(data, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `wealth_command_export_${format(new Date(), 'yyyy-MM-dd')}.json`;
    link.click();
}

function importData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                
                if (data.transactions) transactions = data.transactions;
                if (data.categories) categories = data.categories;
                if (data.monthlyBudgets) monthlyBudgets = data.monthlyBudgets;
                if (data.futureTransactions) futureTransactions = data.futureTransactions;
                if (data.loans) loans = data.loans;
                if (data.currency) currency = data.currency;
                
                saveTransactions();
                saveCategories();
                saveMonthlyBudgets(monthlyBudgets);
                saveFutureTransactions();
                saveLoans();
                localStorage.setItem('currency', currency);
                
                updateUI();
                showToast('Data imported successfully', 'success');
            } catch (error) {
                showToast('Error importing data: Invalid file format', 'danger');
            }
        };
        
        reader.readAsText(file);
    };
    
    input.click();
}

function clearAllData() {
    if (!confirm('Are you sure you want to clear ALL data? This action cannot be undone.')) {
        return;
    }
    
    if (!confirm('This will delete ALL transactions, categories, budgets, and settings. Are you absolutely sure?')) {
        return;
    }
    
    transactions = [];
    categories = [
        { id: 'salary', name: 'Salary', type: 'income', color: '#28a745' },
        { id: 'freelance', name: 'Freelance', type: 'income', color: '#20c997' },
        { id: 'investment', name: 'Investment', type: 'income', color: '#17a2b8' },
        { id: 'food', name: 'Food & Dining', type: 'expense', color: '#dc3545' },
        { id: 'transport', name: 'Transport', type: 'expense', color: '#fd7e14' },
        { id: 'shopping', name: 'Shopping', type: 'expense', color: '#e83e8c' },
        { id: 'entertainment', name: 'Entertainment', type: 'expense', color: '#6f42c1' },
        { id: 'bills', name: 'Bills & Utilities', type: 'expense', color: '#007bff' },
        { id: 'healthcare', name: 'Healthcare', type: 'expense', color: '#6c757d' }
    ];
    monthlyBudgets = {};
    futureTransactions = { income: [], expenses: [] };
    loans = { given: [], taken: [] };
    currency = "PKR";
    
    localStorage.clear();
    saveTransactions();
    saveCategories();
    saveMonthlyBudgets(monthlyBudgets);
    saveFutureTransactions();
    saveLoans();
    localStorage.setItem('currency', currency);
    
    updateUI();
    showToast('All data cleared successfully', 'success');
}

// Export transaction functions for global access
window.addTransaction = addTransaction;
window.addCategory = addCategory;
window.addFutureTransaction = addFutureTransaction;
window.addLoan = addLoan;
window.deleteTransaction = deleteTransaction;
window.deleteFutureTransaction = deleteFutureTransaction;
window.deleteCategory = deleteCategory;
window.addLoanPayment = addLoanPayment;
window.exportData = exportData;
window.importData = importData;
window.clearAllData = clearAllData;
window.updateCurrency = updateCurrency;
