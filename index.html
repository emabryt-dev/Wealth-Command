<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#3B82F6">
    <title>Wealth Command Pro</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui']
                    },
                    colors: {
                        primary: '#3B82F6',
                        success: '#10B981',
                        danger: '#EF4444',
                        warning: '#F59E0B',
                        dark: '#1F2937'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out'
                    }
                }
            }
        }
    </script>
    
    <style>
        .tab-content { 
            display: none; 
            animation: fadeIn 0.3s ease-in-out;
        }
        .tab-content.active { 
            display: block; 
        }
        .nav-button.active { 
            color: #3B82F6;
            transform: translateY(-2px);
        }
        .nav-button.active i {
            transform: scale(1.1);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .stat-card {
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #fff 0%, #f8fafc 100%);
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid #e5e7eb;
            padding: 8px 0 env(safe-area-inset-bottom);
            z-index: 1000;
        }
        
        .main-content {
            padding-bottom: 100px;
        }
        
        .touch-button {
            min-height: 44px;
            min-width: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-indigo-50 font-sans">
    <!-- Header -->
    <div class="glass-effect sticky top-0 z-50 border-b">
        <div class="max-w-xl mx-auto px-4 py-3">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                        Wealth Command
                    </h1>
                    <p class="text-sm text-gray-600" id="currentMonthDisplay">January 2025</p>
                </div>
                <div class="text-right">
                    <div class="text-xl font-bold text-gray-800" id="headerBalance">Rs 0</div>
                    <div class="text-xs text-gray-500">Balance</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content max-w-xl mx-auto px-4 py-4">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active space-y-4">
            <!-- Month Selector & Add Button -->
            <div class="flex gap-3">
                <select id="monthSelect" class="flex-1 border-0 glass-effect rounded-xl px-4 py-3 font-semibold focus:ring-2 focus:ring-primary">
                    <!-- Dynamic months -->
                </select>
                <button onclick="showTransactionModal()" class="bg-gradient-to-r from-primary to-blue-600 text-white px-4 py-3 rounded-xl shadow-lg hover:shadow-xl transition-all touch-button">
                    <i class="fas fa-plus mr-2"></i>
                    <span class="hidden sm:inline">Add</span>
                </button>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div class="stat-card rounded-2xl p-4 shadow-lg border-l-4 border-success">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-2xl font-bold text-success" id="totalIncome">Rs 0</div>
                            <div class="text-sm text-gray-600">Income</div>
                        </div>
                        <i class="fas fa-arrow-down-to-line text-success text-xl opacity-70"></i>
                    </div>
                </div>
                
                <div class="stat-card rounded-2xl p-4 shadow-lg border-l-4 border-danger">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-2xl font-bold text-danger" id="totalExpenses">Rs 0</div>
                            <div class="text-sm text-gray-600">Expenses</div>
                        </div>
                        <i class="fas fa-arrow-up-from-line text-danger text-xl opacity-70"></i>
                    </div>
                </div>
                
                <div class="stat-card rounded-2xl p-4 shadow-lg border-l-4 border-primary">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-2xl font-bold text-primary" id="netAmount">Rs 0</div>
                            <div class="text-sm text-gray-600">Savings</div>
                        </div>
                        <i class="fas fa-piggy-bank text-primary text-xl opacity-70"></i>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="grid grid-cols-2 gap-3">
                <button onclick="switchTab('transactions')" class="glass-effect rounded-xl p-3 text-center hover:shadow-lg transition-all">
                    <i class="fas fa-exchange-alt text-primary text-lg mb-1"></i>
                    <div class="text-sm font-medium">Transactions</div>
                </button>
                <button onclick="switchTab('analytics')" class="glass-effect rounded-xl p-3 text-center hover:shadow-lg transition-all">
                    <i class="fas fa-chart-bar text-success text-lg mb-1"></i>
                    <div class="text-sm font-medium">Analytics</div>
                </button>
            </div>

            <!-- Recent Transactions -->
            <div class="glass-effect rounded-2xl shadow-lg p-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Recent Transactions</h3>
                    <span class="text-xs text-gray-500">This Month</span>
                </div>
                <div id="recentTransactionsList" class="space-y-3">
                    <!-- Dynamic content -->
                </div>
            </div>

            <!-- Category Progress -->
            <div class="glass-effect rounded-2xl shadow-lg p-4">
                <h3 class="text-lg font-semibold mb-4">Category Progress</h3>
                <div id="categoryProgress" class="space-y-4">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>

        <!-- Transactions Tab -->
        <div id="transactions" class="tab-content">
            <div class="glass-effect rounded-2xl shadow-lg p-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">All Transactions</h2>
                    <button onclick="showTransactionModal()" class="bg-primary text-white p-3 rounded-xl hover:bg-blue-600 transition-all touch-button">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                
                <div class="mb-4">
                    <input type="text" id="searchTransactions" placeholder="🔍 Search transactions..." 
                           class="w-full glass-effect border-0 rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary">
                </div>
                
                <div id="transactionsList" class="space-y-3">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content">
            <div class="glass-effect rounded-2xl shadow-lg p-4 mb-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Financial Insights</h2>
                    <select id="analyticsRange" class="glass-effect border-0 rounded-xl px-3 py-2">
                        <option value="3">3 Months</option>
                        <option value="6">6 Months</option>
                        <option value="12">12 Months</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-1 gap-4 mb-4">
                    <div class="bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-2xl p-4">
                        <div class="text-2xl font-bold" id="avgIncome">Rs 0</div>
                        <div class="text-green-100">Avg Monthly Income</div>
                    </div>
                    <div class="bg-gradient-to-r from-red-500 to-pink-600 text-white rounded-2xl p-4">
                        <div class="text-2xl font-bold" id="avgExpenses">Rs 0</div>
                        <div class="text-red-100">Avg Monthly Expenses</div>
                    </div>
                    <div class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-2xl p-4">
                        <div class="text-2xl font-bold" id="avgSavings">Rs 0</div>
                        <div class="text-blue-100">Avg Monthly Savings</div>
                    </div>
                </div>
            </div>

            <div class="glass-effect rounded-2xl shadow-lg p-4">
                <h3 class="text-lg font-semibold mb-4">Monthly Breakdown</h3>
                <div id="monthlyBreakdown" class="space-y-4">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="glass-effect rounded-2xl shadow-lg p-4 mb-4">
                <h2 class="text-xl font-semibold mb-4">Categories</h2>
                
                <button onclick="showAddCategoryModal()" class="w-full bg-gradient-to-r from-success to-green-600 text-white py-3 rounded-xl mb-4 hover:shadow-lg transition-all touch-button">
                    <i class="fas fa-plus mr-2"></i>Add New Category
                </button>
                
                <div id="categoriesList" class="space-y-3">
                    <!-- Dynamic content -->
                </div>
            </div>

            <div class="glass-effect rounded-2xl shadow-lg p-4">
                <h3 class="text-lg font-semibold mb-4">Data Management</h3>
                <div class="space-y-3">
                    <button onclick="exportData()" class="w-full bg-gradient-to-r from-primary to-blue-600 text-white py-3 rounded-xl hover:shadow-lg transition-all touch-button">
                        <i class="fas fa-file-export mr-2"></i>Export Data
                    </button>
                    <button onclick="backupData()" class="w-full bg-gradient-to-r from-warning to-amber-600 text-white py-3 rounded-xl hover:shadow-lg transition-all touch-button">
                        <i class="fas fa-save mr-2"></i>Backup Data
                    </button>
                    <button onclick="resetAllData()" class="w-full bg-gradient-to-r from-danger to-red-600 text-white py-3 rounded-xl hover:shadow-lg transition-all touch-button">
                        <i class="fas fa-trash mr-2"></i>Reset All Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="flex justify-around max-w-xl mx-auto">
            <button class="nav-button flex flex-col items-center touch-button active" onclick="switchTab('dashboard')">
                <i class="fas fa-chart-pie text-lg mb-1"></i>
                <span class="text-xs">Dashboard</span>
            </button>
            <button class="nav-button flex flex-col items-center touch-button" onclick="switchTab('transactions')">
                <i class="fas fa-exchange-alt text-lg mb-1"></i>
                <span class="text-xs">Transactions</span>
            </button>
            <button class="nav-button flex flex-col items-center touch-button" onclick="switchTab('analytics')">
                <i class="fas fa-chart-bar text-lg mb-1"></i>
                <span class="text-xs">Analytics</span>
            </button>
            <button class="nav-button flex flex-col items-center touch-button" onclick="switchTab('settings')">
                <i class="fas fa-cog text-lg mb-1"></i>
                <span class="text-xs">Settings</span>
            </button>
        </div>
    </div>

    <!-- Transaction Modal -->
    <div id="transactionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl w-full max-w-md max-h-[90vh] overflow-y-auto animate-slide-up">
            <div class="sticky top-0 bg-white border-b p-6">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold">Add Transaction</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 touch-button">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Date</label>
                    <input type="date" id="transDate" class="w-full border rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Description</label>
                    <input type="text" id="transDesc" placeholder="What was this for?" class="w-full border rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Type</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="setTransactionType('income')" class="border-2 border-gray-200 rounded-xl py-4 text-center transition-all income-type">
                            <i class="fas fa-arrow-down text-green-500 mr-2"></i>
                            <span class="font-medium">Income</span>
                        </button>
                        <button onclick="setTransactionType('expense')" class="border-2 border-gray-200 rounded-xl py-4 text-center transition-all expense-type">
                            <i class="fas fa-arrow-up text-red-500 mr-2"></i>
                            <span class="font-medium">Expense</span>
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Category</label>
                    <select id="transCategory" class="w-full border rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary" disabled>
                        <option value="">Select a type first</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Amount (Rs)</label>
                    <input type="text" id="transAmount" placeholder="0" class="w-full border rounded-xl px-4 py-3 text-right focus:ring-2 focus:ring-primary" oninput="formatAmount(this)">
                </div>
            </div>
            
            <div class="sticky bottom-0 bg-white border-t p-6">
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="closeModal()" class="border-2 border-gray-300 text-gray-700 rounded-xl py-3 hover:bg-gray-50 transition-all touch-button">Cancel</button>
                    <button onclick="saveTransaction()" class="bg-gradient-to-r from-primary to-blue-600 text-white rounded-xl py-3 hover:shadow-lg transition-all touch-button">Save Transaction</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div id="addCategoryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl w-full max-w-md animate-slide-up">
            <div class="border-b p-6">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold">Add Category</h3>
                    <button onclick="closeCategoryModal()" class="text-gray-400 hover:text-gray-600 touch-button">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Category Name</label>
                    <input type="text" id="newCategoryName" placeholder="Enter category name" class="w-full border rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Monthly Budget (Rs)</label>
                    <input type="text" id="newCategoryBudget" placeholder="0" class="w-full border rounded-xl px-4 py-3 text-right focus:ring-2 focus:ring-primary" oninput="formatAmount(this)">
                </div>
            </div>
            
            <div class="border-t p-6">
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="closeCategoryModal()" class="border-2 border-gray-300 text-gray-700 rounded-xl py-3 hover:bg-gray-50 transition-all">Cancel</button>
                    <button onclick="saveNewCategory()" class="bg-gradient-to-r from-success to-green-600 text-white rounded-xl py-3 hover:shadow-lg transition-all">Save Category</button>
                </div>
            </div>
        </div>
    </div>

    <script>
// Enhanced categories with your specific list
const defaultCategories = [
    'Paycheck', 'Savings', 'Loan Returned', 'Loan Given', 'Committee Taken',
    'Food', 'Gifts', 'Mobile Balance', 'Home', 'Fuel', 'Personal',
    'Committee Given', 'Utilities', 'Debt Payment', 'Other', 'Bike Installment',
    'Bike Maintenance', 'Charity', 'Netflix', 'Loan Taken', 'Others'
];

// App state
let transactions = JSON.parse(localStorage.getItem('financeTransactions')) || [];
let categories = JSON.parse(localStorage.getItem('categories')) || 
    defaultCategories.map(name => ({ name, budget: 10000 }));
let currentMonth = new Date().toLocaleString('default', { month: 'long', year: 'numeric' });
let currentTransactionType = '';

// Utility functions
function formatCurrency(amount) {
    return 'Rs ' + parseInt(amount).toLocaleString('en-PK');
}

function parseCurrency(amountStr) {
    return parseInt(amountStr.replace(/[^0-9]/g, '')) || 0;
}

function formatAmount(input) {
    let value = input.value.replace(/[^0-9]/g, '');
    if (value) {
        value = parseInt(value).toLocaleString('en-PK');
    }
    input.value = value;
}

function updateHeaderBalance() {
    const totalIncome = transactions.filter(t => t.type === 'income')
        .reduce((sum, t) => sum + parseCurrency(t.amount), 0);
    
    const totalExpenses = transactions.filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + parseCurrency(t.amount), 0);
    
    const balance = totalIncome - totalExpenses;
    document.getElementById('headerBalance').textContent = formatCurrency(balance);
}

// Navigation
function switchTab(tabName) {
    // Update bottom nav
    document.querySelectorAll('.nav-button').forEach(btn => {
        btn.classList.remove('active');
        btn.style.transform = 'translateY(0)';
    });
    
    const activeBtn = document.querySelector(`.nav-button:nth-child(${getTabIndex(tabName)})`);
    activeBtn.classList.add('active');
    activeBtn.style.transform = 'translateY(-2px)';

    // Update content
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');

    // Refresh tab content
    if (tabName === 'dashboard') refreshDashboard();
    else if (tabName === 'transactions') renderTransactionsList();
    else if (tabName === 'analytics') refreshAnalytics();
    else if (tabName === 'settings') renderSettings();
}

function getTabIndex(tabName) {
    const tabs = ['dashboard', 'transactions', 'analytics', 'settings'];
    return tabs.indexOf(tabName) + 1;
}

// Dashboard functions
function refreshDashboard() {
    populateMonthSelect();
    updateSummaryCards();
    renderRecentTransactions();
    renderCategoryProgress();
    updateHeaderBalance();
}

function populateMonthSelect() {
    const select = document.getElementById('monthSelect');
    select.innerHTML = '';
    
    const months = [...new Set(transactions.map(t => 
        new Date(t.date).toLocaleString('default', { month: 'long', year: 'numeric' })
    ))].sort((a, b) => new Date('1 ' + a) - new Date('1 ' + b));
    
    months.forEach(month => {
        const option = document.createElement('option');
        option.value = month;
        option.textContent = month;
        select.appendChild(option);
    });
    
    if (months.length > 0) {
        select.value = currentMonth;
        document.getElementById('currentMonthDisplay').textContent = currentMonth;
    }
    
    select.onchange = (e) => {
        currentMonth = e.target.value;
        document.getElementById('currentMonthDisplay').textContent = currentMonth;
        refreshDashboard();
    };
}

function updateSummaryCards() {
    const monthTransactions = transactions.filter(t => 
        new Date(t.date).toLocaleString('default', { month: 'long', year: 'numeric' }) === currentMonth
    );

    const income = monthTransactions.filter(t => t.type === 'income')
        .reduce((sum, t) => sum + parseCurrency(t.amount), 0);
    
    const expenses = monthTransactions.filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + parseCurrency(t.amount), 0);
    
    const savings = income - expenses;

    document.getElementById('totalIncome').textContent = formatCurrency(income);
    document.getElementById('totalExpenses').textContent = formatCurrency(expenses);
    document.getElementById('netAmount').textContent = formatCurrency(savings);
}

function renderRecentTransactions() {
    const container = document.getElementById('recentTransactionsList');
    container.innerHTML = '';

    const recent = transactions
        .filter(t => new Date(t.date).toLocaleString('default', { month: 'long', year: 'numeric' }) === currentMonth)
        .slice(-5)
        .reverse();

    if (recent.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 py-4">No transactions this month</div>';
        return;
    }

    recent.forEach(transaction => {
        const div = document.createElement('div');
        div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
        div.innerHTML = `
            <div class="flex-1">
                <div class="font-semibold">${transaction.description}</div>
                <div class="text-sm text-gray-600">${transaction.category}</div>
            </div>
            <div class="text-right">
                <div class="font-bold ${transaction.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                    ${formatCurrency(parseCurrency(transaction.amount))}
                </div>
                <div class="text-xs text-gray-500">${new Date(transaction.date).toLocaleDateString()}</div>
            </div>
        `;
        container.appendChild(div);
    });
}

function renderCategoryProgress() {
    const container = document.getElementById('categoryProgress');
    container.innerHTML = '';

    const monthTransactions = transactions.filter(t => 
        new Date(t.date).toLocaleString('default', { month: 'long', year: 'numeric' }) === currentMonth &&
        t.type === 'expense'
    );

    const categoryTotals = {};
    monthTransactions.forEach(t => {
        categoryTotals[t.category] = (categoryTotals[t.category] || 0) + parseCurrency(t.amount);
    });

    // Get top 3 categories
    const topCategories = Object.entries(categoryTotals)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3);

    if (topCategories.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 py-4">No expense data this month</div>';
        return;
    }

    topCategories.forEach(([category, amount]) => {
        const categoryData = categories.find(c => c.name === category);
        const budget = categoryData ? categoryData.budget : 0;
        const percentage = budget > 0 ? Math.min((amount / budget) * 100, 100) : 0;
        
        const div = document.createElement('div');
        div.className = 'space-y-2';
        div.innerHTML = `
            <div class="flex justify-between text-sm">
                <span class="font-medium">${category}</span>
                <span>${formatCurrency(amount)} / ${formatCurrency(budget)}</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full transition-all duration-300" 
                      style="width: ${percentage}%"></div>
            </div>
            <div class="flex justify-between text-xs text-gray-600">
                <span>${percentage.toFixed(1)}% used</span>
                <span>${formatCurrency(budget - amount)} remaining</span>
            </div>
        `;
        container.appendChild(div);
    });
}

// Transactions functions
function renderTransactionsList() {
    const container = document.getElementById('transactionsList');
    container.innerHTML = '';

    const sorted = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
    const searchTerm = document.getElementById('searchTransactions').value.toLowerCase();

    const filtered = sorted.filter(t => 
        t.description.toLowerCase().includes(searchTerm) ||
        t.category.toLowerCase().includes(searchTerm) ||
        t.type.toLowerCase().includes(searchTerm)
    );

    if (filtered.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 py-8">No transactions found</div>';
        return;
    }

    filtered.forEach(transaction => {
        const div = document.createElement('div');
        div.className = 'flex justify-between items-center p-4 bg-white rounded-lg shadow-sm border';
        div.innerHTML = `
            <div class="flex-1">
                <div class="font-semibold">${transaction.description}</div>
                <div class="text-sm text-gray-600">
                    ${transaction.category} • ${new Date(transaction.date).toLocaleDateString()}
                </div>
            </div>
            <div class="text-right">
                <div class="font-bold ${transaction.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                    ${formatCurrency(parseCurrency(transaction.amount))}
                </div>
                <button onclick="deleteTransaction('${transaction.id}')" 
                        class="text-red-500 hover:text-red-700 mt-1 touch-button">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        container.appendChild(div);
    });
}

// Analytics functions
function refreshAnalytics() {
    updateAnalyticsSummary();
    renderMonthlyBreakdown();
}

function updateAnalyticsSummary() {
    const range = parseInt(document.getElementById('analyticsRange').value);
    const monthlyData = getMonthlyData(range);
    
    const avgIncome = monthlyData.income.length > 0 ? 
        monthlyData.income.reduce((a, b) => a + b, 0) / monthlyData.income.length : 0;
    const avgExpenses = monthlyData.expenses.length > 0 ? 
        monthlyData.expenses.reduce((a, b) => a + b, 0) / monthlyData.expenses.length : 0;
    const avgSavings = monthlyData.savings.length > 0 ? 
        monthlyData.savings.reduce((a, b) => a + b, 0) / monthlyData.savings.length : 0;

    document.getElementById('avgIncome').textContent = formatCurrency(avgIncome);
    document.getElementById('avgExpenses').textContent = formatCurrency(avgExpenses);
    document.getElementById('avgSavings').textContent = formatCurrency(avgSavings);
}

function renderMonthlyBreakdown() {
    const container = document.getElementById('monthlyBreakdown');
    container.innerHTML = '';

    const range = parseInt(document.getElementById('analyticsRange').value);
    const monthlyData = getMonthlyData(range);

    monthlyData.labels.forEach((month, index) => {
        const income = monthlyData.income[index];
        const expenses = monthlyData.expenses[index];
        const savings = monthlyData.savings[index];
        const savingsRate = income > 0 ? ((savings / income) * 100) : 0;

        const div = document.createElement('div');
        div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
        div.innerHTML = `
            <div class="flex-1">
                <div class="font-semibold">${month}</div>
                <div class="text-sm text-gray-600">
                    Savings Rate: ${savingsRate >= 0 ? '+' : ''}${savingsRate.toFixed(1)}%
                </div>
            </div>
            <div class="text-right space-y-1">
                <div class="text-green-600 font-semibold">+${formatCurrency(income)}</div>
                <div class="text-red-600 font-semibold">-${formatCurrency(expenses)}</div>
                <div class="text-blue-600 font-bold">${formatCurrency(savings)}</div>
            </div>
        `;
        container.appendChild(div);
    });
}

function getMonthlyData(monthCount) {
    const allMonths = [...new Set(transactions.map(t => 
        new Date(t.date).toLocaleString('default', { month: 'short', year: 'numeric' })
    ))].sort((a, b) => new Date('1 ' + a) - new Date('1 ' + b));
    
    const recentMonths = monthCount === 'all' ? allMonths : allMonths.slice(-monthCount);
    
    const income = recentMonths.map(month => 
        transactions.filter(t => 
            new Date(t.date).toLocaleString('default', { month: 'short', year: 'numeric' }) === month &&
            t.type === 'income'
        ).reduce((sum, t) => sum + parseCurrency(t.amount), 0)
    );
    
    const expenses = recentMonths.map(month => 
        transactions.filter(t => 
            new Date(t.date).toLocaleString('default', { month: 'short', year: 'numeric' }) === month &&
            t.type === 'expense'
        ).reduce((sum, t) => sum + parseCurrency(t.amount), 0)
    );
    
    const savings = income.map((inc, i) => inc - expenses[i]);
    
    return { labels: recentMonths, income, expenses, savings };
}

// Settings functions
function renderSettings() {
    renderCategoriesList();
}

function renderCategoriesList() {
    const container = document.getElementById('categoriesList');
    container.innerHTML = '';

    // Separate income and expense categories based on usage
    const categoryUsage = {};
    transactions.forEach(t => {
        categoryUsage[t.category] = categoryUsage[t.category] || { income: 0, expense: 0 };
        categoryUsage[t.category][t.type]++;
    });

    categories.forEach((category, index) => {
        const usage = categoryUsage[category.name] || { income: 0, expense: 0 };
        const isIncomeCategory = usage.income > usage.expense;
        
        const div = document.createElement('div');
        div.className = 'flex justify-between items-center p-3 bg-white rounded-lg border';
        div.innerHTML = `
            <div class="flex items-center space-x-3">
                <div class="w-3 h-3 rounded-full ${isIncomeCategory ? 'bg-green-500' : 'bg-red-500'}"></div>
                <div>
                    <div class="font-semibold">${category.name}</div>
                    <div class="text-sm text-gray-600">Budget: ${formatCurrency(category.budget)}</div>
                </div>
            </div>
            <div class="flex space-x-2">
                <button onclick="editCategory(${index})" class="text-blue-500 hover:text-blue-700 touch-button">
                    <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteCategory(${index})" class="text-red-500 hover:text-red-700 touch-button">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        container.appendChild(div);
    });
}

// Modal functions
function showTransactionModal() {
    document.getElementById('transactionModal').classList.remove('hidden');
    document.getElementById('transDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('transAmount').value = '';
    document.getElementById('transDesc').value = '';
    currentTransactionType = '';
    updateTransactionTypeButtons();
    updateCategoryDropdown();
}

function closeModal() {
    document.getElementById('transactionModal').classList.add('hidden');
}

function setTransactionType(type) {
    currentTransactionType = type;
    updateTransactionTypeButtons();
    updateCategoryDropdown();
}

function updateTransactionTypeButtons() {
    document.querySelectorAll('.income-type, .expense-type').forEach(btn => {
        btn.classList.remove('bg-green-500', 'bg-red-500', 'text-white', 'border-green-500', 'border-red-500');
        btn.classList.add('border-gray-200', 'text-gray-700');
    });
    
    if (currentTransactionType === 'income') {
        document.querySelector('.income-type').classList.add('bg-green-500', 'text-white', 'border-green-500');
        document.querySelector('.income-type').classList.remove('border-gray-200', 'text-gray-700');
    } else if (currentTransactionType === 'expense') {
        document.querySelector('.expense-type').classList.add('bg-red-500', 'text-white', 'border-red-500');
        document.querySelector('.expense-type').classList.remove('border-gray-200', 'text-gray-700');
    }
}

function updateCategoryDropdown() {
    const select = document.getElementById('transCategory');
    select.innerHTML = '';
    select.disabled = !currentTransactionType;
    
    if (currentTransactionType) {
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.name;
            option.textContent = category.name;
            select.appendChild(option);
        });
    } else {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'Select a type first';
        select.appendChild(option);
    }
}

function saveTransaction() {
    const transaction = {
        id: Date.now().toString(),
        date: document.getElementById('transDate').value,
        description: document.getElementById('transDesc').value,
        type: currentTransactionType,
        category: document.getElementById('transCategory').value,
        amount: document.getElementById('transAmount').value
    };

    if (!transaction.date || !transaction.description || !transaction.type || 
        !transaction.category || !transaction.amount || parseCurrency(transaction.amount) <= 0) {
        alert('Please fill all fields correctly');
        return;
    }

    transactions.push(transaction);
    localStorage.setItem('financeTransactions', JSON.stringify(transactions));
    
    closeModal();
    refreshDashboard();
    if (document.getElementById('transactions').classList.contains('active')) {
        renderTransactionsList();
    }
}

function deleteTransaction(id) {
    if (confirm('Delete this transaction?')) {
        transactions = transactions.filter(t => t.id !== id);
        localStorage.setItem('financeTransactions', JSON.stringify(transactions));
        refreshDashboard();
        renderTransactionsList();
    }
}

function showAddCategoryModal() {
    document.getElementById('addCategoryModal').classList.remove('hidden');
    document.getElementById('newCategoryName').value = '';
    document.getElementById('newCategoryBudget').value = '';
}

function closeCategoryModal() {
    document.getElementById('addCategoryModal').classList.add('hidden');
}

function saveNewCategory() {
    const name = document.getElementById('newCategoryName').value.trim();
    const budget = parseCurrency(document.getElementById('newCategoryBudget').value);

    if (!name) {
        alert('Please enter a category name');
        return;
    }

    if (categories.find(c => c.name.toLowerCase() === name.toLowerCase())) {
        alert('Category already exists');
        return;
    }

    categories.push({ name, budget: budget || 0 });
    localStorage.setItem('categories', JSON.stringify(categories));
    
    closeCategoryModal();
    renderSettings();
    updateCategoryDropdown();
}

function editCategory(index) {
    const newName = prompt('Edit category name:', categories[index].name);
    if (newName && newName.trim()) {
        const newBudget = prompt('Edit monthly budget:', categories[index].budget);
        categories[index].name = newName.trim();
        categories[index].budget = parseCurrency(newBudget) || categories[index].budget;
        localStorage.setItem('categories', JSON.stringify(categories));
        renderSettings();
        refreshDashboard();
    }
}

function deleteCategory(index) {
    if (confirm('Delete this category? Transactions using this category will be preserved.')) {
        categories.splice(index, 1);
        localStorage.setItem('categories', JSON.stringify(categories));
        renderSettings();
    }
}

// Search functionality
document.getElementById('searchTransactions').addEventListener('input', renderTransactionsList);

// Data management functions
function exportData() {
    const csv = ['Date,Description,Type,Category,Amount']
        .concat(transactions.map(t => 
            `"${t.date}","${t.description}","${t.type}","${t.category}","${t.amount}"`
        )).join('\n');
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `wealth-command-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
}

function backupData() {
    const backup = {
        transactions: transactions,
        categories: categories,
        exportDate: new Date().toISOString()
    };
    
    const dataStr = JSON.stringify(backup, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `wealth-command-backup-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
}

function resetAllData() {
    if (confirm('This will delete ALL your data. Continue?')) {
        localStorage.removeItem('financeTransactions');
        localStorage.removeItem('categories');
        transactions = [];
        categories = defaultCategories.map(name => ({ name, budget: 10000 }));
        localStorage.setItem('categories', JSON.stringify(categories));
        refreshDashboard();
        renderSettings();
    }
}

// Initialize app
function initApp() {
    if (!localStorage.getItem('categories')) {
        localStorage.setItem('categories', JSON.stringify(categories));
    }
    refreshDashboard();
    switchTab('dashboard');
}

// Start the app when DOM is ready
document.addEventListener('DOMContentLoaded', initApp);
    </script>

    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('✅ ServiceWorker registered: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('❌ ServiceWorker registration failed: ', error);
                    });
            });
        }
    </script>
</body>
</html>
